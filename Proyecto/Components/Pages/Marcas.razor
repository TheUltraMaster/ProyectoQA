@page "/marcas"
@rendermode InteractiveServer
@attribute [Authorize(Policy="AdminOnly")]
@using BD.Models
@using Proyecto.DTOS
@using Proyecto.Services
@using Proyecto.Components.Dialogs
@using System.ComponentModel.DataAnnotations
@inject IMarcaService MarcaService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Gesti칩n de Marcas</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <MudText Typo="Typo.h4" Class="mb-4">Gesti칩n de Marcas</MudText>

    <MudCard Class="mb-4">
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="searchTerm" 
                                  Label="Buscar por nombre" 
                                  Variant="Variant.Outlined" 
                                  Adornment="Adornment.End"
                                  AdornmentIcon="Icons.Material.Filled.Search"
                                  OnAdornmentClick="SearchMarcas"
                                  OnKeyUp="OnSearchKeyUp" />
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudSelect T="int" Value="pageSize" 
                               Label="Registros por p치gina"
                               Variant="Variant.Outlined"
                               ValueChanged="OnPageSizeChanged">
                        <MudSelectItem Value="10">10</MudSelectItem>
                        <MudSelectItem Value="25">25</MudSelectItem>
                        <MudSelectItem Value="50">50</MudSelectItem>
                        <MudSelectItem Value="100">100</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6" Class="d-flex align-center justify-space-between">
                    <div>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   StartIcon="Icons.Material.Filled.Search"
                                   OnClick="SearchMarcas">
                            Buscar
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Secondary" 
                                   StartIcon="Icons.Material.Filled.Clear"
                                   OnClick="ClearSearch"
                                   Class="ml-2">
                            Limpiar
                        </MudButton>
                    </div>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               StartIcon="Icons.Material.Filled.Add"
                               OnClick="OpenCreateMarcaDialog"
                               Class="ml-4">
                        Nueva Marca
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <MudCard>
        <MudCardContent>
            @if (isLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            else
            {
                <div class="mb-3 d-flex justify-space-between align-center">
                    <MudText Typo="Typo.h6">
                        Mostrando @GetDisplayRange() de @totalMarcas marcas
                    </MudText>
                    <MudText Typo="Typo.body2" Class="text-muted">
                        P치gina @currentPage de @totalPages
                    </MudText>
                </div>
                
                <MudTable Items="@marcas" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>Nombre</MudTh>
                        <MudTh>Equipos Asociados</MudTh>
                        <MudTh>Acciones</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Nombre">@context.Nombre</MudTd>
                        <MudTd DataLabel="Equipos Asociados">
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">
                                @context.Equipos.Count equipos
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Acciones">
                            <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                                <MudButton Color="Color.Primary" 
                                           StartIcon="Icons.Material.Filled.Edit"
                                           OnClick="() => OpenEditMarcaDialog(context)"
                                           Size="Size.Small">
                                    Editar
                                </MudButton>
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                
                @if (totalPages > 1)
                {
                    <div class="d-flex justify-center mt-4">
                        <MudPagination Count="totalPages" 
                                       Selected="currentPage"
                                       SelectedChanged="OnPageChanged"
                                       Size="Size.Medium"
                                       ShowFirstButton="true"
                                       ShowLastButton="true"
                                       ShowPreviousButton="true"
                                       ShowNextButton="true" />
                    </div>
                }
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private List<Marca> marcas = new();
    private bool isLoading = true;
    private string searchTerm = "";
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalMarcas = 0;
    private int totalPages = 0;
    
    private DialogOptions dialogOptions = new()
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.Medium,
        FullWidth = true
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadMarcas();
    }

    private async Task LoadMarcas()
    {
        await RefreshCurrentView();
    }

    private async Task SearchMarcas()
    {
        currentPage = 1; // Reset to first page when searching
        await RefreshCurrentView();
    }

    private async Task ClearSearch()
    {
        searchTerm = "";
        currentPage = 1;
        await LoadMarcas();
    }
    
    private async Task OnPageChanged(int page)
    {
        if (currentPage != page)
        {
            currentPage = page;
            await RefreshCurrentView();
        }
    }
    
    private async Task OnPageSizeChanged(int newPageSize)
    {
        if (pageSize != newPageSize)
        {
            pageSize = newPageSize;
            currentPage = 1; // Reset to first page when page size changes
            await RefreshCurrentView();
        }
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchMarcas();
        }
    }
    
    private string GetDisplayRange()
    {
        if (totalMarcas == 0) return "0";
        
        var start = (currentPage - 1) * pageSize + 1;
        var end = Math.Min(currentPage * pageSize, totalMarcas);
        
        return $"{start}-{end}";
    }

    private async Task RefreshCurrentView()
    {
        isLoading = true;
        try
        {
            var result = await MarcaService.GetMarcasPagedAsync(currentPage, pageSize, searchTerm);
            marcas = result.Marcas;
            totalMarcas = result.TotalCount;
            totalPages = (int)Math.Ceiling((double)totalMarcas / pageSize);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar marcas: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
    
    // Create Marca Methods
    private async Task OpenCreateMarcaDialog()
    {
        var parameters = new DialogParameters();
        parameters.Add("IsEditMode", false);

        var dialog = await DialogService.ShowAsync<CreateEditMarcaDialog>("Crear Nueva Marca", parameters, dialogOptions);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await RefreshCurrentView();
        }
    }
    
    // Edit Marca Methods
    private async Task OpenEditMarcaDialog(Marca marca)
    {
        var parameters = new DialogParameters();
        parameters.Add("IsEditMode", true);
        parameters.Add("Marca", marca);

        var dialog = await DialogService.ShowAsync<CreateEditMarcaDialog>($"Editar Marca - {marca.Nombre}", parameters, dialogOptions);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await RefreshCurrentView();
        }
    }

}