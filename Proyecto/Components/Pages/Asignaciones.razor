@page "/asignaciones"
@rendermode InteractiveServer
@using BD.Models
@using Proyecto.DTOS
@using Proyecto.Services
@using Proyecto.Components.Dialogs
@inject IEquipoService EquipoService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Asignación de Equipos</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <MudText Typo="Typo.h4" Class="mb-4">Asignación de Equipos</MudText>

    <MudCard Class="mb-4">
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudSwitch Value="@mostrarAsignados"
                               Color="Color.Primary"
                               Label="@(mostrarAsignados ? "Mostrando Equipos Asignados" : "Mostrando Equipos No Asignados")"
                               T="bool"
                               ValueChanged="OnModoChanged" />
                </MudItem>
                <MudItem xs="12" md="6" Class="d-flex justify-end align-center">
                    @if (equiposSeleccionados.Any())
                    {
                        <MudChip T="string" Color="Color.Info" Icon="@Icons.Material.Filled.CheckCircle">
                            @equiposSeleccionados.Count equipo(s) seleccionado(s)
                        </MudChip>
                    }
                </MudItem>
            </MudGrid>
            <MudGrid Class="mt-3">
                <MudItem xs="12" Class="d-flex justify-center gap-2">
                    @if (!mostrarAsignados)
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.Assignment"
                                   OnClick="AbrirModalAsignar"
                                   Disabled="@(!equiposSeleccionados.Any())"
                                   Size="Size.Small">
                            Asignar Equipos
                        </MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Warning"
                                   StartIcon="@Icons.Material.Filled.RemoveCircle"
                                   OnClick="AbrirModalDesasignar"
                                   Disabled="@(!equiposSeleccionados.Any())"
                                   Size="Size.Small">
                            Desasignar Equipos
                        </MudButton>
                    }
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="LimpiarSeleccion"
                               Disabled="@(!equiposSeleccionados.Any())"
                               Size="Size.Small">
                        Limpiar Selección
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="CargarEquipos"
                               Size="Size.Small">
                        Actualizar
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    @if (isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }

    <MudCard>
        <MudCardContent>
            <MudTextField @bind-Value="searchString"
                          Placeholder="Buscar por nombre de equipo..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mb-3"
                          Clearable="true"
                          Immediate="true"
                          DebounceInterval="300"
                          OnDebounceIntervalElapsed="FiltrarEquipos" />

            <MudTable @ref="mudTable"
                      Items="@equiposFiltrados"
                      Hover="true"
                      Striped="true"
                      Dense="true"
                      Bordered="true"
                      Loading="@isLoading"
                      LoadingProgressColor="Color.Primary">
                <HeaderContent>
                    <MudTh>
                        <MudCheckBox T="bool"
                                     Value="@todosMarcados"
                                     ValueChanged="@((bool val) => SeleccionarTodos(val))"
                                     Color="Color.Primary" />
                    </MudTh>
                    <MudTh>Identificador</MudTh>
                    <MudTh>Nombre</MudTh>
                    <MudTh>Tipo</MudTh>
                    <MudTh>Marca</MudTh>
                    <MudTh>Serie</MudTh>
                    <MudTh>Estado</MudTh>
                    @if (mostrarAsignados)
                    {
                        <MudTh>Empleado Asignado</MudTh>
                    }
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudCheckBox T="bool"
                                     Value="@equiposSeleccionados.Contains(context.Id.Value)"
                                     ValueChanged="@((bool val) => ToggleSeleccion(context.Id.Value, val))"
                                     Color="Color.Primary" />
                    </MudTd>
                    <MudTd>@context.Identificador</MudTd>
                    <MudTd>@context.Nombre</MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">
                            @context.Tipo.GetDescription().ToUpper()
                        </MudChip>
                    </MudTd>
                    <MudTd>@context.MarcaNombre</MudTd>
                    <MudTd>@context.Serie</MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small"
                                 Color="@ObtenerColorEstado(context.Estado)">
                            @context.Estado.GetDescription().ToUpper()
                        </MudChip>
                    </MudTd>
                    @if (mostrarAsignados)
                    {
                        <MudTd>@context.EmpleadoNombre</MudTd>
                    }
                </RowTemplate>
                <NoRecordsContent>
                    <MudText Typo="Typo.body1" Align="Align.Center" Class="py-4">
                        @if (string.IsNullOrWhiteSpace(searchString))
                        {
                            @if (mostrarAsignados)
                            {
                                <text>No hay equipos asignados</text>
                            }
                            else
                            {
                                <text>No hay equipos sin asignar</text>
                            }
                        }
                        else
                        {
                            <text>No se encontraron equipos que coincidan con la búsqueda</text>
                        }
                    </MudText>
                </NoRecordsContent>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }"
                                   InfoFormat="@($"Mostrando {infoFormat}")"
                                   RowsPerPageString="Equipos por página:" />
                </PagerContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private MudTable<EquipoDto>? mudTable;
    private List<EquipoDto> equipos = new();
    private IEnumerable<EquipoDto> equiposFiltrados = new List<EquipoDto>();
    private HashSet<int> equiposSeleccionados = new();
    private bool mostrarAsignados = false;
    private bool isLoading = false;
    private bool todosMarcados = false;
    private string searchString = "";
    private string infoFormat = "{first_item}-{last_item} de {all_items}";

    protected override async Task OnInitializedAsync()
    {
        await CargarEquipos();
    }

    private async Task CargarEquipos()
    {
        isLoading = true;
        try
        {
            if (mostrarAsignados)
            {
                equipos = await EquipoService.GetEquiposAsignadosAsync();
            }
            else
            {
                equipos = await EquipoService.GetEquiposNoAsignadosAsync();
            }

            FiltrarEquipos();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar equipos: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FiltrarEquipos()
    {
        if (string.IsNullOrWhiteSpace(searchString))
        {
            equiposFiltrados = equipos;
        }
        else
        {
            equiposFiltrados = equipos.Where(e =>
                !string.IsNullOrEmpty(e.Nombre) &&
                e.Nombre.Contains(searchString, StringComparison.OrdinalIgnoreCase)
            ).ToList();
        }

        // Actualizar el checkbox de "todos marcados" al filtrar
        todosMarcados = equiposFiltrados.Any() && equiposFiltrados.All(e => e.Id.HasValue && equiposSeleccionados.Contains(e.Id.Value));
    }

    private async Task OnModoChanged(bool nuevoValor)
    {
        mostrarAsignados = nuevoValor;
        LimpiarSeleccion();
        await CargarEquipos();
    }

    private void ToggleSeleccion(int equipoId, bool seleccionado)
    {
        if (seleccionado)
        {
            equiposSeleccionados.Add(equipoId);
        }
        else
        {
            equiposSeleccionados.Remove(equipoId);
            todosMarcados = false;
        }

        // Actualizar estado de "todos marcados" basado en equipos filtrados
        todosMarcados = equiposFiltrados.Any() && equiposFiltrados.All(e => e.Id.HasValue && equiposSeleccionados.Contains(e.Id.Value));
    }

    private void SeleccionarTodos(bool seleccionar)
    {
        todosMarcados = seleccionar;

        if (seleccionar)
        {
            // Seleccionar solo los equipos filtrados visibles
            foreach (var equipo in equiposFiltrados)
            {
                if (equipo.Id.HasValue)
                {
                    equiposSeleccionados.Add(equipo.Id.Value);
                }
            }
        }
        else
        {
            // Deseleccionar solo los equipos filtrados visibles
            foreach (var equipo in equiposFiltrados)
            {
                if (equipo.Id.HasValue)
                {
                    equiposSeleccionados.Remove(equipo.Id.Value);
                }
            }
        }
    }

    private void LimpiarSeleccion()
    {
        equiposSeleccionados.Clear();
        todosMarcados = false;
    }

    private async Task AbrirModalAsignar()
    {
        if (!equiposSeleccionados.Any())
        {
            Snackbar.Add("Debe seleccionar al menos un equipo", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<AsignarEquiposDialog>
        {
            { x => x.EquipoIds, equiposSeleccionados.ToList() }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AsignarEquiposDialog>("Asignar Equipos a Empleado", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await CargarEquipos();
            LimpiarSeleccion();
            Snackbar.Add("Equipos asignados correctamente", Severity.Success);
        }
    }

    private async Task AbrirModalDesasignar()
    {
        if (!equiposSeleccionados.Any())
        {
            Snackbar.Add("Debe seleccionar al menos un equipo", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<DesasignarEquiposDialog>
        {
            { x => x.EquipoIds, equiposSeleccionados.ToList() }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<DesasignarEquiposDialog>("Desasignar Equipos", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await CargarEquipos();
            LimpiarSeleccion();
            Snackbar.Add("Equipos desasignados correctamente", Severity.Success);
        }
    }

    private Color ObtenerColorEstado(EstadoEquipo estado)
    {
        return estado switch
        {
            EstadoEquipo.Activo => Color.Success,
            EstadoEquipo.Inactivo => Color.Default,
            EstadoEquipo.Mantenimiento => Color.Warning,
            EstadoEquipo.Suspendido => Color.Error,
            _ => Color.Default
        };
    }
}
